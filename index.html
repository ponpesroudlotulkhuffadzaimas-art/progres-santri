function doGet(e) {
  const action = e.parameter.action || "";

  if (action == "stat") return json(getStatistik());
  if (action == "get") return json(getData(e.parameter.kategori));
  if (action == "add") return json(addData(e.parameter.kategori, e.parameter));

  return json({ status: "OK", message: "API Aktif" });
}

function json(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader("Access-Control-Allow-Origin", "*");
}

// ===== DATA =====

function getSheet(name) {
  const ss = SpreadsheetApp.getActive();
  let sh = ss.getSheetByName(name);
  if (!sh) {
    sh = ss.insertSheet(name);
    if (name == "Tahfidz")
      sh.appendRow(["ID","Nama","Surah","Dari","Sampai","Ket"]);
    if (name == "Kitab")
      sh.appendRow(["ID","Nama","Kitab","Jumlah","Ket"]);
    if (name == "Lainnya")
      sh.appendRow(["ID","Progres","Nama","Jenis","Ket"]);
  }
  return sh;
}

function getData(kategori) {
  const sh = getSheet(kategori);
  const data = sh.getDataRange().getValues();
  const head = data.shift();

  return data.map(r => {
    let o = {};
    head.forEach((h,i)=>o[h]=r[i]);
    return o;
  });
}

function addData(kategori, p) {
  const sh = getSheet(kategori);
  const id = Utilities.getUuid();

  if (kategori == "Tahfidz")
    sh.appendRow([id,p.nama,p.surah,p.dari,p.sampai,p.ket]);

  if (kategori == "Kitab")
    sh.appendRow([id,p.nama,p.kitab,p.jumlah,p.ket]);

  if (kategori == "Lainnya")
    sh.appendRow([id,p.progres,p.nama,p.jenis,p.ket]);

  return {success:true};
}

function getStatistik() {
  return {
    tahfidz: getSheet("Tahfidz").getLastRow()-1,
    kitab: getSheet("Kitab").getLastRow()-1,
    lainnya: getSheet("Lainnya").getLastRow()-1
  }
}
